jobs:
  build_master:
    machine:
      image: circleci/classic:edge
    steps:
      - checkout
      - run:
          name: Setup Environment
          command: |
            docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}
      - run:
          name: Build docker container
          command: |
            docker build -t szymonrychu/k8s-ros-master:${CIRCLE_SHA1} -f Dockerfile_master .
      - run:
          name: Tag and push docker container
          command: |
            docker tag szymonrychu/k8s-ros-master:${CIRCLE_SHA1} szymonrychu/k8s-ros-master:latest
            docker push szymonrychu/k8s-ros-master:${CIRCLE_SHA1}
            docker push szymonrychu/k8s-ros-master:latest
  test_on_k8s:
    machine:
      image: circleci/classic:edge
    steps:
      - run:
          name: spin up kubernetes docker image
          command: |
            export K8S_VERSION=$(curl -sS https://storage.googleapis.com/kubernetes-release/release/latest.txt)
            export ARCH=amd64
            mkdir /etc/kubernetes/pods
            sudo mount --make-shared /sys/
            sudo mount --make-shared /var/run/
            docker run -d --privileged --net=host --pid=host \
              -v /:/rootfs:ro \
              -v /sys:/sys:ro \
              -v /var/run:/var/run \
              -v /var/lib/kubelet:/var/lib/kubelet \
              -v /etc/kubernetes:/etc/kubernetes \
              gcr.io/google_containers/hyperkube-amd64:v1.3.0 /hyperkube kubelet \
                --allow-privileged=true \
                --enable-server=false \
                --hostname-override=127.0.0.1 \
                --config=/etc/kubernetes/pods \
                --containerized \
                --v=2 \
                --healthz-port=0 \
                --read-only-port=0 \
                --cadvisor-port=0
            curl -sSL "https://storage.googleapis.com/kubernetes-release/release/v1.3.0/bin/linux/amd64/kubectl" > ./kubectl
            chmod +x ./kubectl
            ./kubectl config set-cluster test-doc --server=http://localhost:8080
            ./kubectl config set-context test-doc --cluster=test-doc
            ./kubectl config use-context test-doc
            ./kubectl get nodes

workflows:
  version: 2
  build_and_push:
    jobs:
      - build_master
      - test_on_k8s:
          requires:
            - build_master

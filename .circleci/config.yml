jobs:
  build:
    machine:
      image: circleci/classic:edge
    steps:
      - checkout
      - run:
          name: Setup Environment
          command: |
            docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}
      - run:
          name: Build docker container
          command: |
            docker build -t szymonrychu/k8s-ros-master:${CIRCLE_SHA1} .
      - run:
          name: Tag and push docker container
          command: |
            docker tag szymonrychu/k8s-ros-master:${CIRCLE_SHA1} szymonrychu/k8s-ros-master:latest
            docker push szymonrychu/k8s-ros-master:${CIRCLE_SHA1}
            docker push szymonrychu/k8s-ros-master:latest
  test_on_k8s:
    machine:
      image: circleci/classic:edge
    steps:
      - checkout
      - run:
          name: spin up kubernetes docker image
          command: |
            curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.27.0/minikube-linux-amd64
            chmod +x minikube
            sudo mv minikube /usr/local/bin/
            curl -sSL "https://storage.googleapis.com/kubernetes-release/release/v1.3.0/bin/linux/amd64/kubectl" > ./kubectl
            chmod +x ./kubectl
            sudo mv kubectl /usr/local/bin/

            git clone https://github.com/metral/nanokube
            cd nanokube
            sudo apt-get update > /dev/null 2>&1
            sudo apt-get install linux-image-extra-$(uname -r) -y
            sudo modprobe aufs
            sudo su -c bash -c "PRIVATE_MASTER_IF=\"eth0\" ./nanokube.sh -t" &
            until kubectl cluster-info | grep KubeDNS > /dev/null 2>&1 ; do sleep 1; done
      - run:
          name: do stuff with k8s
          command: |
            kubectl cluster-info
            kubectl apply -f master_deployment.yaml --namespace default

workflows:
  version: 2
  build_and_push:
    jobs:
      - build:
          filters:
            branches:
              only:
                - /^master*$/
      - test_on_k8s:
          filters:
            branches:
              only:
                - /^master*$/

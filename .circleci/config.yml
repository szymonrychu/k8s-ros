jobs:

  build:
    machine:
      image: circleci/classic:edge
    steps:
      - checkout
      - run:
          name: Setup Environment
          command: |
            docker login -u ${DOCKER_USER} -p ${DOCKER_PASS}
      - run:
          name: Build docker container
          command: |
            docker build -t szymonrychu/k8s-ros-master:${CIRCLE_SHA1} .
      - run:
          name: Tag and push docker container
          command: |
            docker tag szymonrychu/k8s-ros-master:${CIRCLE_SHA1} szymonrychu/k8s-ros-master:latest
            docker push szymonrychu/k8s-ros-master:${CIRCLE_SHA1}
            docker push szymonrychu/k8s-ros-master:latest
  test_on_k8s:
    machine:
      image: circleci/classic:edge
    steps:
      - run:
          name: spin up kubernetes docker image
          command: |
            curl -Lo minikube https://storage.googleapis.com/minikube/releases/v0.27.0/minikube-linux-amd64
            chmod +x minikube
            sudo mv minikube /usr/local/bin/
            curl -sSL "https://storage.googleapis.com/kubernetes-release/release/v1.3.0/bin/linux/amd64/kubectl" > ./kubectl
            chmod +x ./kubectl
            sudo mv kubectl /usr/local/bin/

            export MINIKUBE_WANTUPDATENOTIFICATION=false
            export MINIKUBE_WANTREPORTERRORPROMPT=false
            export MINIKUBE_HOME=$HOME
            export CHANGE_MINIKUBE_NONE_USER=true
            mkdir -p $HOME/.kube
            touch $HOME/.kube/config

            export KUBECONFIG=$HOME/.kube/config
            sudo -E minikube start --kubernetes-version v1.10.4 --vm-driver=none

            # this for loop waits until kubectl can access the api server that Minikube has created
            for i in {1..150}; do # timeout for 5 minutes
               kubectl get pod &> /dev/null
               if [ $? -ne 1 ]; then
                  break
              fi
              sleep 2
            done
            kubectl cluster-info

workflows:
  version: 2
  build_and_push:
    jobs:
      - build:
          filters:
            branches:
              only:
                - /^master*$/
      - test_on_k8s
